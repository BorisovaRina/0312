using System;
using System.Data;
using System.IO;
using System.Xml;
using System.Collections.Generic;
using Newtonsoft.Json; 
class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateHierarchyDataSet();
            FillTestData(ds);
            CreateRelationships(ds);
            
            Console.WriteLine("=== –ó–ê–î–ê–ù–ò–ï 18: –≠–ö–°–ü–û–†–¢ –ò–ï–†–ê–†–•–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–• ===\n");
            
            Console.WriteLine("1. –ò–°–•–û–î–ù–ê–Ø –ò–ï–†–ê–†–•–ò–Ø:");
            PrintHierarchyConsole(ds);
            Console.WriteLine();
            
            Console.WriteLine("2. –≠–ö–°–ü–û–†–¢ –í XML (DataSet.WriteXml):");
            ExportToXml(ds);
            Console.WriteLine();
            
            Console.WriteLine("3. –†–ï–ö–£–†–°–ò–í–ù–´–ô –≠–ö–°–ü–û–†–¢ –í JSON:");
            ExportRecursiveJson(ds);
            Console.WriteLine();
            
            Console.WriteLine("4. CSV –° –ò–ï–†–ê–†–•–ò–ï–ô:");
            ExportToCsvHierarchy(ds);
            Console.WriteLine();
            
            Console.WriteLine("5. –ò–ú–ü–û–†–¢ –ò–ó XML:");
            ImportFromXmlAndVerify(ds);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û–®–ò–ë–ö–ê: {ex.Message}");
        }
    }
    
    static DataSet CreateHierarchyDataSet()
    {
        DataSet ds = new DataSet("CompanyHierarchy");
        
        // –û—Ç–¥–µ–ª—ã
        DataTable departments = new DataTable("–û—Ç–¥–µ–ª—ã");
        departments.Columns.Add("DepartmentID", typeof(int));
        departments.Columns.Add("DepartmentName", typeof(string));
        departments.PrimaryKey = new DataColumn[] { departments.Columns["DepartmentID"] };
        
        // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
        DataTable employees = new DataTable("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏");
        employees.Columns.Add("EmployeeID", typeof(int));
        employees.Columns.Add("EmployeeName", typeof(string));
        employees.Columns.Add("Position", typeof(string));
        employees.Columns.Add("Salary", typeof(decimal));
        employees.Columns.Add("DepartmentID", typeof(int));
        employees.PrimaryKey = new DataColumn[] { employees.Columns["EmployeeID"] };
        
        // –ü—Ä–æ–µ–∫—Ç—ã
        DataTable projects = new DataTable("–ü—Ä–æ–µ–∫—Ç—ã");
        projects.Columns.Add("ProjectID", typeof(int));
        projects.Columns.Add("ProjectName", typeof(string));
        projects.Columns.Add("EmployeeID", typeof(int)); // –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
        projects.PrimaryKey = new DataColumn[] { projects.Columns["ProjectID"] };
        
        ds.Tables.Add(departments);
        ds.Tables.Add(employees);
        ds.Tables.Add(projects);
        
        return ds;
    }
    
    static void FillTestData(DataSet ds)
    {
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        DataTable emps = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        DataTable projs = ds.Tables["–ü—Ä–æ–µ–∫—Ç—ã"];
        
        // –û—Ç–¥–µ–ª—ã
        depts.Rows.Add(1, "IT –û—Ç–¥–µ–ª");
        depts.Rows.Add(2, "HR –û—Ç–¥–µ–ª");
        depts.Rows.Add(3, "–ü—Ä–æ–¥–∞–∂–∏");
        
        // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
        emps.Rows.Add(101, "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤", "Lead Developer", 250000m, 1);
        emps.Rows.Add(102, "–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞", "HR Manager", 180000m, 2);
        emps.Rows.Add(103, "–ê–ª–µ–∫—Å–µ–π –ù–æ–≤–∏–∫–æ–≤", "Senior Developer", 220000m, 1);
        emps.Rows.Add(104, "–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞", "Sales Manager", 200000m, 3);
        emps.Rows.Add(105, "–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤", "Junior Developer", 120000m, 1);
        
        // –ü—Ä–æ–µ–∫—Ç—ã
        projs.Rows.Add(1, "ERP –°–∏—Å—Ç–µ–º–∞", 101);
        projs.Rows.Add(2, "HR Portal", 102);
        projs.Rows.Add(3, "CRM –ú–æ–¥—É–ª—å", 103);
        projs.Rows.Add(4, "–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", 105);
    }
    
    static void CreateRelationships(DataSet ds)
    {
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        DataTable emps = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        DataTable projs = ds.Tables["–ü—Ä–æ–µ–∫—Ç—ã"];
        
        // –û—Ç–¥–µ–ª—ã ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
        DataRelation rel1 = new DataRelation("Rel_Departments_Employees",
            depts.Columns["DepartmentID"], emps.Columns["DepartmentID"]);
        ds.Relations.Add(rel1);
        
        // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ‚Üí –ü—Ä–æ–µ–∫—Ç—ã
        DataRelation rel2 = new DataRelation("Rel_Employees_Projects",
            emps.Columns["EmployeeID"], projs.Columns["EmployeeID"]);
        ds.Relations.Add(rel2);
    }
    
    static void PrintHierarchyConsole(DataSet ds)
    {
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        foreach (DataRow dept in depts.Rows)
        {
            Console.WriteLine($"üìÅ {dept["DepartmentName"]} (ID:{dept["DepartmentID"]})");
            
            DataRow[] emps = dept.GetChildRows("Rel_Departments_Employees");
            foreach (DataRow emp in emps)
            {
                Console.WriteLine($"  üë§ {emp["EmployeeName"]} - {emp["Position"]} ({emp["Salary"]:N0}‚ÇΩ)");
                
                DataRow[] projs = emp.GetChildRows("Rel_Employees_Projects");
                foreach (DataRow proj in projs)
                {
                    Console.WriteLine($"    üìã {proj["ProjectName"]}");
                }
            }
            Console.WriteLine();
        }
    }
    
    static void ExportToXml(DataSet ds)
    {
        string xmlFile = "CompanyHierarchy.xml";
        ds.WriteXml(xmlFile, XmlWriteMode.WriteSchema);
        Console.WriteLine($"‚úì DataSet.WriteXml() ‚Üí {xmlFile} (—Å—Ö–µ–º–∞ + –¥–∞–Ω–Ω—ã–µ + –æ—Ç–Ω–æ—à–µ–Ω–∏—è)");
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ XML
        Console.WriteLine("–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ XML:");
        string[] xmlLines = File.ReadAllLines(xmlFile);
        for (int i = 0; i < Math.Min(10, xmlLines.Length); i++)
        {
            Console.WriteLine($"  {xmlLines[i]}");
        }
        if (xmlLines.Length > 10) Console.WriteLine($"  ... {xmlLines.Length - 10} —Å—Ç—Ä–æ–∫...");
    }
    
    static void ExportRecursiveJson(DataSet ds)
    {
        var hierarchy = new List<object>();
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        
        foreach (DataRow dept in depts.Rows)
        {
            var departmentData = new Dictionary<string, object>
            {
                ["DepartmentID"] = dept["DepartmentID"],
                ["DepartmentName"] = dept["DepartmentName"],
                ["Employees"] = GetEmployeeHierarchy(dept, ds)
            };
            hierarchy.Add(departmentData);
        }
        
        string json = JsonConvert.SerializeObject(hierarchy, Formatting.Indented);
        File.WriteAllText("CompanyHierarchy.json", json);
        Console.WriteLine("‚úì –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π JSON ‚Üí CompanyHierarchy.json");
        Console.WriteLine("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON:");
        Console.WriteLine(json.Substring(0, Math.Min(300, json.Length)));
        if (json.Length > 300) Console.WriteLine("...");
    }
    
    static object[] GetEmployeeHierarchy(DataRow deptRow, DataSet ds)
    {
        var employees = new List<object>();
        DataRow[] emps = deptRow.GetChildRows("Rel_Departments_Employees");
        
        foreach (DataRow emp in emps)
        {
            var employeeData = new Dictionary<string, object>
            {
                ["EmployeeID"] = emp["EmployeeID"],
                ["EmployeeName"] = emp["EmployeeName"],
                ["Position"] = emp["Position"],
                ["Salary"] = emp["Salary"],
                ["Projects"] = GetProjectsForEmployee(emp, ds)
            };
            employees.Add(employeeData);
        }
        return employees.ToArray();
    }
    
    static object[] GetProjectsForEmployee(DataRow empRow, DataSet ds)
    {
        DataRow[] projs = empRow.GetChildRows("Rel_Employees_Projects");
        var projects = new List<object>();
        
        foreach (DataRow proj in projs)
        {
            projects.Add(new Dictionary<string, object>
            {
                ["ProjectID"] = proj["ProjectID"],
                ["ProjectName"] = proj["ProjectName"]
            });
        }
        return projects.ToArray();
    }
    
    static void ExportToCsvHierarchy(DataSet ds)
    {
        using (var writer = new StreamWriter("CompanyHierarchy.csv"))
        {
            writer.WriteLine("–£—Ä–æ–≤–µ–Ω—å,DepartmentID,DepartmentName,EmployeeID,EmployeeName,Position,Salary,ProjectID,ProjectName");
            
            DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
            foreach (DataRow dept in depts.Rows)
            {
                writer.WriteLine($"1,{dept["DepartmentID"]},{dept["DepartmentName"]},,,,\"\",");
                
                DataRow[] emps = dept.GetChildRows("Rel_Departments_Employees");
                foreach (DataRow emp in emps)
                {
                    writer.WriteLine($"2,,,{emp["EmployeeID"]},{emp["EmployeeName"]},{emp["Position"]},{emp["Salary"]},,\"\",");
                    
                    DataRow[] projs = emp.GetChildRows("Rel_Employees_Projects");
                    foreach (DataRow proj in projs)
                    {
                        writer.WriteLine($"3,,,,,,,{proj["ProjectID"]},{proj["ProjectName"]}");
                    }
                }
            }
        }
        Console.WriteLine("‚úì CSV —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π ‚Üí CompanyHierarchy.csv");
    }
    
    static void ImportFromXmlAndVerify(DataSet dsOriginal)
    {
        string xmlFile = "CompanyHierarchy.xml";
        DataSet dsImported = new DataSet();
        
        try
        {
            dsImported.ReadXml(xmlFile, XmlReadMode.ReadSchema);
            Console.WriteLine($"‚úì –ò–º–ø–æ—Ä—Ç –∏–∑ XML: {dsImported.Tables.Count} —Ç–∞–±–ª–∏—Ü");
            
            Console.WriteLine("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:");
            Console.WriteLine($"  –û—Ç–¥–µ–ª—ã: {dsImported.Tables["–û—Ç–¥–µ–ª—ã"]?.Rows.Count ?? 0}");
            Console.WriteLine($"  –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: {dsImported.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"]?.Rows.Count ?? 0}");
            Console.WriteLine($"  –ü—Ä–æ–µ–∫—Ç—ã: {dsImported.Tables["–ü—Ä–æ–µ–∫—Ç—ã"]?.Rows.Count ?? 0}");
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
            int relCount = 0;
            foreach (DataRelation rel in dsImported.Relations)
            {
                Console.WriteLine($"  –û—Ç–Ω–æ—à–µ–Ω–∏–µ: {rel.RelationName}");
                relCount++;
            }
            Console.WriteLine($"  –û—Ç–Ω–æ—à–µ–Ω–∏–π: {relCount}");
            
            Console.WriteLine("‚úì –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω! –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û–®–ò–ë–ö–ê –∏–º–ø–æ—Ä—Ç–∞: {ex.Message}");
        }
    }
}
