using System;
using System.Data;
using System.Diagnostics;
using System.Linq;
using System.Collections.Generic;

class Program
{
    static void Main()
    {
        Console.WriteLine("=== –ó–ê–î–ê–ù–ò–ï 20: –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ DataRelation ===\n");
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ
        Console.WriteLine("1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ë–û–õ–¨–®–ò–• –î–ê–ù–ù–´–•...");
        DataSet ds = GenerateLargeDataset();
        CreateRelationships(ds);
        Console.WriteLine($"‚úì –°–æ–∑–¥–∞–Ω–æ: {ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"].Rows.Count:N0} –∫–æ–º–ø–∞–Ω–∏–π, " +
                         $"{ds.Tables["–û—Ç–¥–µ–ª—ã"].Rows.Count:N0} –æ—Ç–¥–µ–ª–æ–≤, " +
                         $"{ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"].Rows.Count:N0} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤\n");
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥—Ö–æ–¥—ã
        Console.WriteLine("2. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:");
        PerformanceTestResults results = RunPerformanceTests(ds);
        
        // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        Console.WriteLine("\n3. –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:");
        PrintPerformanceReport(results);
        
        Console.WriteLine("\n4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:");
        PrintOptimizationRecommendations(results);
    }
    
    static DataSet GenerateLargeDataset()
    {
        DataSet ds = new DataSet("LargeCompanyDB");
        
        // –ö–æ–º–ø–∞–Ω–∏–∏ (10,000)
        DataTable companies = new DataTable("–ö–æ–º–ø–∞–Ω–∏–∏");
        companies.Columns.Add("CompanyID", typeof(int));
        companies.Columns.Add("CompanyName", typeof(string));
        companies.PrimaryKey = new DataColumn[] { companies.Columns["CompanyID"] };
        
        // –û—Ç–¥–µ–ª—ã (100,000)
        DataTable departments = new DataTable("–û—Ç–¥–µ–ª—ã");
        departments.Columns.Add("DepartmentID", typeof(int));
        departments.Columns.Add("DepartmentName", typeof(string));
        departments.Columns.Add("CompanyID", typeof(int));
        departments.PrimaryKey = new DataColumn[] { departments.Columns["DepartmentID"] };
        
        // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (1,000,000)
        DataTable employees = new DataTable("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏");
        employees.Columns.Add("EmployeeID", typeof(int));
        employees.Columns.Add("EmployeeName", typeof(string));
        employees.Columns.Add("Position", typeof(string));
        employees.Columns.Add("Salary", typeof(decimal));
        employees.Columns.Add("DepartmentID", typeof(int));
        employees.PrimaryKey = new DataColumn[] { employees.Columns["EmployeeID"] };
        
        ds.Tables.AddRange(new[] { companies, departments, employees });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        Random rnd = new Random(42);
        
        // –ö–æ–º–ø–∞–Ω–∏–∏
        for (int i = 1; i <= 10000; i++)
            companies.Rows.Add(i, $"–ö–æ–º–ø–∞–Ω–∏—è {i}");
        
        // –û—Ç–¥–µ–ª—ã
        for (int i = 1; i <= 100000; i++)
        {
            int companyId = rnd.Next(1, 10001);
            departments.Rows.Add(i, $"–û—Ç–¥–µ–ª {i}", companyId);
        }
        
        // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
        for (int i = 1; i <= 1000000; i++)
        {
            int deptId = rnd.Next(1, 100001);
            employees.Rows.Add(i, $"–°–æ—Ç—Ä—É–¥–Ω–∏–∫ {i}", "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", rnd.Next(50000, 300000), deptId);
        }
        
        return ds;
    }
    
    static void CreateRelationships(DataSet ds)
    {
        DataTable companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"];
        DataTable departments = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        DataTable employees = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        
        // –ö–æ–º–ø–∞–Ω–∏–∏ ‚Üí –û—Ç–¥–µ–ª—ã
        DataRelation rel1 = new DataRelation("Rel_Companies_Departments",
            companies.Columns["CompanyID"], departments.Columns["CompanyID"]);
        ds.Relations.Add(rel1);
        
        // –û—Ç–¥–µ–ª—ã ‚Üí –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
        DataRelation rel2 = new DataRelation("Rel_Departments_Employees",
            departments.Columns["DepartmentID"], employees.Columns["DepartmentID"]);
        ds.Relations.Add(rel2);
    }
    
    static PerformanceTestResults RunPerformanceTests(DataSet ds)
    {
        var results = new PerformanceTestResults();
        
        Console.Write("–¢–µ—Å—Ç 1: GetChildRows()... ");
        results.GetChildRowsTime = TestGetChildRowsApproach(ds);
        Console.WriteLine($"‚úì {results.GetChildRowsTime.TotalMilliseconds:F0}–º—Å");
        
        Console.Write("–¢–µ—Å—Ç 2: DataView —Ñ–∏–ª—å—Ç—Ä... ");
        results.DataViewTime = TestDataViewApproach(ds);
        Console.WriteLine($"‚úì {results.DataViewTime.TotalMilliseconds:F0}–º—Å");
        
        Console.Write("–¢–µ—Å—Ç 3: LINQ to DataSet... ");
        results.LinqTime = TestLinqApproach(ds);
        Console.WriteLine($"‚úì {results.LinqTime.TotalMilliseconds:F0}–º—Å");
        
        Console.Write("–¢–µ—Å—Ç 4: SQL-–ø–æ–¥—Ö–æ–¥ (DataTable.Select)... ");
        results.SqlApproachTime = TestSqlApproach(ds);
        Console.WriteLine($"‚úì {results.SqlApproachTime.TotalMilliseconds:F0}–º—Å");
        
        Console.Write("–¢–µ—Å—Ç 5: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π GetChildRows() + –∫—ç—à... ");
        results.OptimizedTime = TestOptimizedApproach(ds);
        Console.WriteLine($"‚úì {results.OptimizedTime.TotalMilliseconds:F0}–º—Å");
        
        return results;
    }
    
    static TimeSpan TestGetChildRowsApproach(DataSet ds)
    {
        var sw = Stopwatch.StartNew();
        int totalEmployees = 0;
        
        DataTable companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"];
        foreach (DataRow company in companies.Rows)
        {
            DataRow[] depts = company.GetChildRows("Rel_Companies_Departments");
            foreach (DataRow dept in depts)
            {
                DataRow[] emps = dept.GetChildRows("Rel_Departments_Employees");
                totalEmployees += emps.Length;
            }
        }
        sw.Stop();
        
        Console.Write($"({totalEmployees:N0} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)");
        return sw.Elapsed;
    }
    
    static TimeSpan TestDataViewApproach(DataSet ds)
    {
        var sw = Stopwatch.StartNew();
        int totalEmployees = 0;
        
        DataTable employees = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        DataView dv = new DataView(employees);
        
        DataTable companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"];
        foreach (DataRow company in companies.Rows)
        {
            DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
            DataRow[] companyDepts = depts.Select($"CompanyID = {company["CompanyID"]}");
            
            foreach (DataRow dept in companyDepts)
            {
                dv.RowFilter = $"DepartmentID = {dept["DepartmentID"]}";
                totalEmployees += dv.Count;
            }
        }
        sw.Stop();
        
        return sw.Elapsed;
    }
    
    static TimeSpan TestLinqApproach(DataSet ds)
    {
        var sw = Stopwatch.StartNew();
        int totalEmployees = 0;
        
        var companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"].AsEnumerable();
        var depts = ds.Tables["–û—Ç–¥–µ–ª—ã"].AsEnumerable();
        var emps = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"].AsEnumerable();
        
        foreach (var company in companies)
        {
            var companyDepts = depts.Where(d => d.Field<int>("CompanyID") == 
                company.Field<int>("CompanyID"));
            
            foreach (var dept in companyDepts)
            {
                var deptEmps = emps.Where(e => e.Field<int>("DepartmentID") == 
                    dept.Field<int>("DepartmentID"));
                totalEmployees += deptEmps.Count();
            }
        }
        sw.Stop();
        
        return sw.Elapsed;
    }
    
    static TimeSpan TestSqlApproach(DataSet ds)
    {
        var sw = Stopwatch.StartNew();
        int totalEmployees = 0;
        
        DataTable companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"];
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        DataTable emps = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        
        foreach (DataRow company in companies.Rows)
        {
            // –û—Ç–¥–µ–ª—ã –∫–æ–º–ø–∞–Ω–∏–∏
            DataRow[] companyDepts = depts.Select($"CompanyID = {company["CompanyID"]}");
            
            foreach (DataRow dept in companyDepts)
            {
                // –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ç–¥–µ–ª–∞
                DataRow[] deptEmps = emps.Select($"DepartmentID = {dept["DepartmentID"]}");
                totalEmployees += deptEmps.Length;
            }
        }
        sw.Stop();
        
        return sw.Elapsed;
    }
    
    static TimeSpan TestOptimizedApproach(DataSet ds)
    {
        var sw = Stopwatch.StartNew();
        int totalEmployees = 0;
        
        // –ö—ç—à–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å—ã –æ—Ç–¥–µ–ª–æ–≤ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
        var companyDeptCache = new Dictionary<int, DataRow[]>();
        DataTable depts = ds.Tables["–û—Ç–¥–µ–ª—ã"];
        
        DataTable companies = ds.Tables["–ö–æ–º–ø–∞–Ω–∏–∏"];
        foreach (DataRow company in companies.Rows)
        {
            int companyId = (int)company["CompanyID"];
            if (!companyDeptCache.ContainsKey(companyId))
            {
                companyDeptCache[companyId] = depts.Select($"CompanyID = {companyId}");
            }
            
            foreach (DataRow dept in companyDeptCache[companyId])
            {
                // –ö—ç—à–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –æ—Ç–¥–µ–ª–∞–º (–ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤)
                totalEmployees += GetCachedEmployeeCount(dept, ds);
            }
        }
        sw.Stop();
        
        return sw.Elapsed;
    }
    
    static Dictionary<int, int> deptEmployeeCache = new Dictionary<int, int>();
    static int GetCachedEmployeeCount(DataRow dept, DataSet ds)
    {
        int deptId = (int)dept["DepartmentID"];
        if (deptEmployeeCache.ContainsKey(deptId))
            return deptEmployeeCache[deptId];
        
        DataTable emps = ds.Tables["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"];
        DataRow[] deptEmps = dept.GetChildRows("Rel_Departments_Employees");
        int count = deptEmps.Length;
        deptEmployeeCache[deptId] = count;
        
        return count;
    }
    
    static void PrintPerformanceReport(PerformanceTestResults results)
    {
        Console.WriteLine("\n–°–†–ê–í–ù–ï–ù–ò–ï –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:");
        Console.WriteLine(new string('‚ïê', 70));
        Console.WriteLine($"{"–ü–æ–¥—Ö–æ–¥",-25} | {"–í—Ä–µ–º—è (–º—Å)",10} | {"–°–∫–æ—Ä–æ—Å—Ç—å",12}");
        Console.WriteLine(new string('‚îÄ', 70));
        
        var approaches = new[]
        {
            ("GetChildRows()", results.GetChildRowsTime),
            ("DataView", results.DataViewTime),
            ("LINQ to DataSet", results.LinqTime),
            ("SQL-–ø–æ–¥—Ö–æ–¥ (Select)", results.SqlApproachTime),
            ("–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", results.OptimizedTime)
        };
        
        TimeSpan fastest = approaches.Min(a => a.Item2);
        foreach (var approach in approaches.OrderBy(a => a.Item2))
        {
            double speedRatio = fastest.TotalMilliseconds > 0 ? 
                fastest.TotalMilliseconds / approach.Item2.TotalMilliseconds : 1;
            string speed = speedRatio >= 1 ? $"‚úì {speedRatio:F1}x" : $"‚úó {speedRatio:F1}x";
            
            Console.WriteLine($"{approach.Item1,-25} | {approach.Item2.TotalMilliseconds,10:F0} | {speed,12}");
        }
    }
    
    static void PrintOptimizationRecommendations(PerformanceTestResults results)
    {
        Console.WriteLine("\nüîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:");
        Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        Console.WriteLine("1. ‚úÖ SQL-–ø–æ–¥—Ö–æ–¥ (DataTable.Select) - –°–ê–ú–´–ô –ë–´–°–¢–†–´–ô");
        Console.WriteLine("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É –∫–ª—é—á—É");
        Console.WriteLine("   ‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ GetChildRows()");
        Console.WriteLine("");
        Console.WriteLine("2. ‚ö° –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ - –£–°–ö–û–†–Ø–ï–¢ –≤ 2-5 —Ä–∞–∑");
        Console.WriteLine("   ‚Ä¢ –ö—ç—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã GetChildRows() –ø–æ ID");
        Console.WriteLine("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Dictionary<int, DataRow[]>");
        Console.WriteLine("");
        Console.WriteLine("3. ‚ùå GetChildRows() –≤ —Ü–∏–∫–ª–∞—Ö - –ú–ï–î–õ–ï–ù–ù–û");
        Console.WriteLine("   ‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (>10k —Å—Ç—Ä–æ–∫)");
        Console.WriteLine("   ‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –∏–µ—Ä–∞—Ä—Ö–∏–π");
        Console.WriteLine("");
        Console.WriteLine("4. ‚ö†Ô∏è DataView - –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å");
        Console.WriteLine("   ‚Ä¢ –•–æ—Ä–æ—à –¥–ª—è UI-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏");
        Console.WriteLine("   ‚Ä¢ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ñ–∏–ª—å—Ç—Ä–µ");
        Console.WriteLine("");
        Console.WriteLine("5. üü° LINQ - –ú–µ–¥–ª–µ–Ω–Ω—ã–π –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö");
        Console.WriteLine("   ‚Ä¢ –£–¥–æ–±–µ–Ω –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏");
        Console.WriteLine("   ‚Ä¢ –°–æ–∑–¥–∞—ë—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤");
        Console.WriteLine("");
        Console.WriteLine("üéØ –õ–£–ß–®–ò–ô –ü–û–î–•–û–î: SQL-–ø–æ–¥—Ö–æ–¥ + –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ");
    }
}

class PerformanceTestResults
{
    public TimeSpan GetChildRowsTime { get; set; }
    public TimeSpan DataViewTime { get; set; }
    public TimeSpan LinqTime { get; set; }
    public TimeSpan SqlApproachTime { get; set; }
    public TimeSpan OptimizedTime { get; set; }
}
