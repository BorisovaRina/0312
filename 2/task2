using System;
using System.Data;
using System.Linq;
using System.Collections.Generic;

class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateDataSet();

            FillTestData(ds);

            CreateRelationship(ds);

            Console.WriteLine("=== Ğ—ĞĞ”ĞĞĞ˜Ğ• 1+2: ĞĞ¢ĞĞĞ¨Ğ•ĞĞ˜Ğ• + GetChildRows() ===\n");

            PrintRelationInfo(ds);
            Console.WriteLine();

            PrintHierarchicalStructure(ds);
            Console.WriteLine();

            Console.WriteLine("3. ĞŸĞĞ”Ğ¡Ğ§ĞĞ¢ Ğ¢ĞĞ’ĞĞ ĞĞ’ ĞŸĞ ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ¯Ğœ:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            CountProductsPerCategory(ds);
            Console.WriteLine();

            Console.WriteLine("4. ĞĞ‘Ğ©ĞĞ¯ Ğ¡Ğ¢ĞĞ˜ĞœĞĞ¡Ğ¢Ğ¬ Ğ¢ĞĞ’ĞĞ ĞĞ’ ĞŸĞ ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ¯Ğœ:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            CalculateTotalValuePerCategory(ds);
            Console.WriteLine();

            Console.WriteLine("5. ĞŸĞĞ˜Ğ¡Ğš Ğ¢ĞĞ’ĞĞ ĞĞ’ Ğ’ ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ˜ (ID=1):");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            FindProductsInCategory(ds, 1);
            Console.WriteLine();

            Console.WriteLine("6. ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ˜ Ğ¡ Ğ¢ĞĞ’ĞĞ ĞĞœĞ˜ Ğ”ĞĞ ĞĞ–Ğ• 50000â‚½:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            FilterExpensiveProducts(ds, 50000m);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ĞĞ¨Ğ˜Ğ‘ĞšĞ: {ex.Message}");
        }
    }

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ DataSet Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼Ğ¸
    static DataSet CreateDataSet()
    {
        DataSet ds = new DataSet("ShopDB");

        // Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
        DataTable categories = new DataTable("ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸");
        categories.Columns.Add("CategoryID", typeof(int));
        categories.Columns.Add("CategoryName", typeof(string));
        categories.Columns.Add("Description", typeof(string));
        categories.PrimaryKey = new DataColumn[] { categories.Columns["CategoryID"] };

        // Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Quantity)
        DataTable products = new DataTable("Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹");
        products.Columns.Add("ProductID", typeof(int));
        products.Columns.Add("ProductName", typeof(string));
        products.Columns.Add("Price", typeof(decimal));
        products.Columns.Add("Quantity", typeof(int));
        products.Columns.Add("CategoryID", typeof(int));
        products.PrimaryKey = new DataColumn[] { products.Columns["ProductID"] };

        ds.Tables.Add(categories);
        ds.Tables.Add(products);

        return ds;
    }

    // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    static void FillTestData(DataSet ds)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];
        DataTable products = ds.Tables["Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹"];

        // ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
        categories.Rows.Add(1, "Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ¸ĞºĞ°", "Ğ¡Ğ¼Ğ°Ñ€Ñ‚Ñ„Ğ¾Ğ½Ñ‹, Ğ¿Ğ»Ğ°Ğ½ÑˆĞµÑ‚Ñ‹, Ğ³Ğ°Ğ´Ğ¶ĞµÑ‚Ñ‹");
        categories.Rows.Add(2, "ĞĞ´ĞµĞ¶Ğ´Ğ°", "ĞœÑƒĞ¶ÑĞºĞ°Ñ Ğ¸ Ğ¶ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ´ĞµĞ¶Ğ´Ğ°");
        categories.Rows.Add(3, "ĞšĞ½Ğ¸Ğ³Ğ¸", "Ğ¥ÑƒĞ´Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ğ¸ ÑƒÑ‡ĞµĞ±Ğ½Ğ°Ñ Ğ»Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°");
        categories.Rows.Add(4, "Ğ‘Ñ‹Ñ‚Ğ¾Ğ²Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°", "Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ¸Ğ»ÑŒĞ½Ğ¸ĞºĞ¸, ÑÑ‚Ğ¸Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹");

        // Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹
        products.Rows.Add(1, "iPhone 15 Pro", 129990m, 5, 1);
        products.Rows.Add(2, "Samsung Galaxy S24", 89990m, 8, 1);
        products.Rows.Add(3, "Xiaomi 14", 59990m, 12, 1);
        products.Rows.Add(4, "iPad Air", 74990m, 3, 1);

        products.Rows.Add(5, "Ğ”Ğ¶Ğ¸Ğ½ÑÑ‹ Levi's", 5990m, 20, 2);
        products.Rows.Add(6, "ĞšÑƒÑ€Ñ‚ĞºĞ° Adidas", 12990m, 10, 2);
        products.Rows.Add(7, "Ğ¤ÑƒÑ‚Ğ±Ğ¾Ğ»ĞºĞ° Nike", 2490m, 50, 2);

        products.Rows.Add(8, "Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ¸ Ğ¼Ğ¸Ñ€", 1290m, 100, 3);
        products.Rows.Add(9, "C# in Depth", 2890m, 25, 3);

        products.Rows.Add(10, "Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº LG", 45990m, 2, 4);
        products.Rows.Add(11, "Ğ¡Ñ‚Ğ¸Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ° Bosch", 37990m, 3, 4);
    }

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ
    static void CreateRelationship(DataSet ds)
    {
        try
        {
            DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];
            DataTable products = ds.Tables["Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹"];

            DataRelation relation = new DataRelation(
                "FK_Categories_Products",
                categories.Columns["CategoryID"],
                products.Columns["CategoryID"],
                true
            );

            ds.Relations.Add(relation);
            Console.WriteLine("âœ“ ĞÑ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾");
        }
        catch (ArgumentException ex)
        {
            Console.WriteLine($"ĞĞ¨Ğ˜Ğ‘ĞšĞ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ: {ex.Message}");
        }
    }

    static void PrintRelationInfo(DataSet ds)
    {
        Console.WriteLine("Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ ĞĞ¢ĞĞĞ¨Ğ•ĞĞ˜Ğ˜:");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        DataRelation relation = ds.Relations["FK_Categories_Products"];

        Console.WriteLine($"Ğ˜Ğ¼Ñ: {relation.RelationName}");
        Console.WriteLine($"Ğ Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ: {relation.ParentTable.TableName}");
        Console.WriteLine($"Ğ”Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğ¹: {relation.ChildTable.TableName}");
        Console.WriteLine($"ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸: {relation.ParentColumns[0].ColumnName} â†’ {relation.ChildColumns[0].ColumnName}");
    }

    static void PrintHierarchicalStructure(DataSet ds)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];

        Console.WriteLine("Ğ˜Ğ•Ğ ĞĞ Ğ¥Ğ˜Ğ¯ (GetChildRows()):");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        foreach (DataRow categoryRow in categories.Rows)
        {
            string categoryName = (string)categoryRow["CategoryName"];
            Console.WriteLine($"\nğŸ“ {categoryName}:");

            DataRow[] products = categoryRow.GetChildRows("FK_Categories_Products");

            if (products.Length == 0)
            {
                Console.WriteLine("   â””â”€â”€ ĞĞµÑ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²");
                continue;
            }

            foreach (DataRow product in products)
            {
                Console.WriteLine($"   â€¢ {product["ProductName"]} ({product["Price"]})");
            }
        }
    }


    // 3. ĞŸĞ¾Ğ´ÑÑ‡Ñ‘Ñ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼
    static void CountProductsPerCategory(DataSet ds)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];

        Console.WriteLine("ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ            | Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

        foreach (DataRow category in categories.Rows)
        {
            DataRow[] products = category.GetChildRows("FK_Categories_Products");
            string categoryName = (string)category["CategoryName"];
            Console.WriteLine($"{categoryName,-20} | {products.Length,7}");
        }
    }

    // 4. ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼ (Price * Quantity)
    static void CalculateTotalValuePerCategory(DataSet ds)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];

        Console.WriteLine("ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ            | ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

        foreach (DataRow category in categories.Rows)
        {
            DataRow[] products = category.GetChildRows("FK_Categories_Products");
            decimal totalValue = 0;

            foreach (DataRow product in products)
            {
                decimal price = (decimal)product["Price"];
                int quantity = (int)product["Quantity"];
                totalValue += price * quantity;
            }

            string categoryName = (string)category["CategoryName"];
            Console.WriteLine($"{categoryName,-20} | {totalValue:N0} â‚½");
        }
    }

    // 5. ĞŸĞ¾Ğ¸ÑĞº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
    static void FindProductsInCategory(DataSet ds, int categoryID)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];
        DataRow category = categories.Rows.Find(categoryID);

        if (category == null)
        {
            Console.WriteLine("ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°");
            return;
        }

        Console.WriteLine($"Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ '{category["CategoryName"]}':");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

        DataRow[] products = category.GetChildRows("FK_Categories_Products");

        if (products.Length == 0)
        {
            Console.WriteLine("ĞĞµÑ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²");
            return;
        }

        foreach (DataRow product in products)
        {
            Console.WriteLine($"â€¢ {product["ProductName"]} - {product["Price"]:N0}â‚½ (Ğ² Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸: {product["Quantity"]})");
        }
    }

    // 6. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
    static void FilterExpensiveProducts(DataSet ds, decimal minPrice)
    {
        DataTable categories = ds.Tables["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"];
        var categoriesWithExpensive = new List<string>();

        foreach (DataRow category in categories.Rows)
        {
            DataRow[] products = category.GetChildRows("FK_Categories_Products");

            bool hasExpensive = false;
            foreach (DataRow product in products)
            {
                if ((decimal)product["Price"] >= minPrice)
                {
                    hasExpensive = true;
                    break;
                }
            }

            if (hasExpensive)
                categoriesWithExpensive.Add((string)category["CategoryName"]);
        }

        Console.WriteLine($"ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ â‰¥ {minPrice:N0}â‚½:");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

        if (categoriesWithExpensive.Count == 0)
        {
            Console.WriteLine("ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾");
        }
        else
        {
            foreach (string cat in categoriesWithExpensive)
            {
                Console.WriteLine($"â€¢ {cat}");
            }
        }
    }
}
