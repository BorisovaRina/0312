using System;
using System.Data;

class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateDataSet();
            FillTestData(ds);
            CreateRelationship(ds);

            Console.WriteLine("=== –ó–ê–î–ê–ù–ò–ï 3: GetParentRows() - –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ï –°–¢–†–û–ö–ò ===\n");

            PrintRelationInfo(ds);
            Console.WriteLine();

            PrintHierarchicalStructure(ds);
            Console.WriteLine();

            Console.WriteLine("1. –¢–û–í–ê–†–´ –° –ò–• –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò:");
            Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            PrintProductsWithCategories(ds);
            Console.WriteLine();

            Console.WriteLine("2. –ü–û–ò–°–ö –¢–û–í–ê–†–ê –ü–û ID (ProductID=3):");
            Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            FindProductByID(ds, 3);
            Console.WriteLine();

            Console.WriteLine("3. –û–¢–ß–Å–¢: –¢–û–í–ê–† ‚Üí –ö–ê–¢–ï–ì–û–†–ò–Ø ‚Üí –û–ü–ò–°–ê–ù–ò–ï:");
            Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            PrintProductCategoryReport(ds);
            Console.WriteLine();

            Console.WriteLine("4. –°–ò–†–û–¢–´ (–¢–û–í–ê–†–´ –ë–ï–ó –ö–ê–¢–ï–ì–û–†–ò–ô):");
            Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            FindOrphanedProducts(ds);
            Console.WriteLine();

            Console.WriteLine("5. –ù–ê–†–£–®–ï–ù–ò–Ø –°–°–´–õ–û–ß–ù–û–ô –¶–ï–õ–û–°–¢–ù–û–°–¢–ò:");
            Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            CheckReferentialIntegrity(ds);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û–®–ò–ë–ö–ê: {ex.Message}");
        }
    }

    static DataSet CreateDataSet()
    {
        DataSet ds = new DataSet("ShopDB");

        DataTable categories = new DataTable("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏");
        categories.Columns.Add("CategoryID", typeof(int));
        categories.Columns.Add("CategoryName", typeof(string));
        categories.Columns.Add("Description", typeof(string));
        categories.PrimaryKey = new DataColumn[] { categories.Columns["CategoryID"] };

        DataTable products = new DataTable("–¢–æ–≤–∞—Ä—ã");
        products.Columns.Add("ProductID", typeof(int));
        products.Columns.Add("ProductName", typeof(string));
        products.Columns.Add("Price", typeof(decimal));
        products.Columns.Add("Quantity", typeof(int));
        products.Columns.Add("CategoryID", typeof(int));
        products.PrimaryKey = new DataColumn[] { products.Columns["ProductID"] };

        ds.Tables.Add(categories);
        ds.Tables.Add(products);

        return ds;
    }

    static void FillTestData(DataSet ds)
    {
        DataTable categories = ds.Tables["–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"];
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];

        categories.Rows.Add(1, "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", "–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã, –ø–ª–∞–Ω—à–µ—Ç—ã, –≥–∞–¥–∂–µ—Ç—ã");
        categories.Rows.Add(2, "–û–¥–µ–∂–¥–∞", "–ú—É–∂—Å–∫–∞—è –∏ –∂–µ–Ω—Å–∫–∞—è –æ–¥–µ–∂–¥–∞");
        categories.Rows.Add(3, "–ö–Ω–∏–≥–∏", "–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏ —É—á–µ–±–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞");
        categories.Rows.Add(4, "–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞", "–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏, —Å—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã");

        products.Rows.Add(1, "iPhone 15 Pro", 129990m, 5, 1);
        products.Rows.Add(2, "Samsung Galaxy S24", 89990m, 8, 1);
        products.Rows.Add(3, "Xiaomi 14", 59990m, 12, 1);
        products.Rows.Add(4, "iPad Air", 74990m, 3, 1);
        products.Rows.Add(5, "–î–∂–∏–Ω—Å—ã Levi's", 5990m, 20, 2);
        products.Rows.Add(6, "–ö—É—Ä—Ç–∫–∞ Adidas", 12990m, 10, 2);
        products.Rows.Add(7, "–§—É—Ç–±–æ–ª–∫–∞ Nike", 2490m, 50, 2);
        products.Rows.Add(8, "–í–æ–π–Ω–∞ –∏ –º–∏—Ä", 1290m, 100, 3);
        products.Rows.Add(9, "C# in Depth", 2890m, 25, 3);
        products.Rows.Add(10, "–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ LG", 45990m, 2, 4);
        products.Rows.Add(11, "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ Bosch", 37990m, 3, 4);
        products.Rows.Add(12, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä", 999m, 1, 999);
    }

    static void CreateRelationship(DataSet ds)
    {
        DataTable categories = ds.Tables["–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"];
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];

        DataRelation relation = new DataRelation(
            "FK_Categories_Products",
            categories.Columns["CategoryID"],
            products.Columns["CategoryID"],
            true
        );

        ds.Relations.Add(relation);
    }

    static void PrintRelationInfo(DataSet ds)
    {
        DataRelation relation = ds.Relations["FK_Categories_Products"];

        Console.WriteLine($"–ò–º—è: {relation.RelationName}");
        Console.WriteLine($"–†–æ–¥–∏—Ç–µ–ª—å: {relation.ParentTable.TableName}");
        Console.WriteLine($"–î–æ—á–µ—Ä–Ω–∏–π: {relation.ChildTable.TableName}");
        Console.WriteLine($"–ö–æ–ª–æ–Ω–∫–∏: {relation.ParentColumns[0].ColumnName} ‚Üí {relation.ChildColumns[0].ColumnName}");
    }

    static void PrintHierarchicalStructure(DataSet ds)
    {
        DataTable categories = ds.Tables["–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"];

        foreach (DataRow categoryRow in categories.Rows)
        {
            string categoryName = (string)categoryRow["CategoryName"];
            Console.WriteLine($"\nüìÅ {categoryName}:");

            DataRow[] products = categoryRow.GetChildRows("FK_Categories_Products");

            if (products.Length == 0)
            {
                Console.WriteLine("   ‚îî‚îÄ‚îÄ –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤");
                continue;
            }

            foreach (DataRow product in products)
            {
                Console.WriteLine($"   ‚Ä¢ {product["ProductName"]} ({product["Price"]})");
            }
        }
    }

    static void PrintProductsWithCategories(DataSet ds)
    {
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];

        Console.WriteLine("–¢–æ–≤–∞—Ä                 | –ö–∞—Ç–µ–≥–æ—Ä–∏—è       | –¶–µ–Ω–∞");
        Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");

        foreach (DataRow product in products.Rows)
        {
            DataRow[] categories = product.GetParentRows("FK_Categories_Products");
            string categoryName = categories.Length > 0 ? (string)categories[0]["CategoryName"] : "–ù–ï –ò–ó–í–ï–°–¢–ù–û";

            Console.WriteLine($"{((string)product["ProductName"]):-20} | {categoryName,-15} | {((decimal)product["Price"]):N0}‚ÇΩ");
        }
    }

    static void FindProductByID(DataSet ds, int productID)
    {
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];
        DataRow product = products.Rows.Find(productID);

        if (product == null)
        {
            Console.WriteLine("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }

        Console.WriteLine($"–¢–æ–≤–∞—Ä: {product["ProductName"]}");
        Console.WriteLine($"–¶–µ–Ω–∞: {((decimal)product["Price"]):N0}‚ÇΩ");

        DataRow[] categories = product.GetParentRows("FK_Categories_Products");
        if (categories.Length > 0)
        {
            DataRow category = categories[0];
            Console.WriteLine($"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category["CategoryName"]}");
            Console.WriteLine($"–û–ø–∏—Å–∞–Ω–∏–µ: {category["Description"]}");
        }
        else
        {
            Console.WriteLine("–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ù–ï –ù–ê–ô–î–ï–ù–ê");
        }
    }

    static void PrintProductCategoryReport(DataSet ds)
    {
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];

        Console.WriteLine("–¢–æ–≤–∞—Ä                 | –ö–∞—Ç–µ–≥–æ—Ä–∏—è       | –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
        Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");

        foreach (DataRow product in products.Rows)
        {
            DataRow[] categories = product.GetParentRows("FK_Categories_Products");
            string categoryName = categories.Length > 0 ? (string)categories[0]["CategoryName"] : "–ù–ï –ò–ó–í–ï–°–¢–ù–û";
            string description = categories.Length > 0 ? (string)categories[0]["Description"] : "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";

            Console.WriteLine($"{((string)product["ProductName"]):-20} | {categoryName,-15} | {description}");
        }
    }

    static void FindOrphanedProducts(DataSet ds)
    {
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];
        int orphans = 0;

        Console.WriteLine("–°–∏—Ä–æ—Ç—ã (—Ç–æ–≤–∞—Ä—ã –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π):");
        Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");

        foreach (DataRow product in products.Rows)
        {
            DataRow[] categories = product.GetParentRows("FK_Categories_Products");
            if (categories.Length == 0)
            {
                Console.WriteLine($"‚Ä¢ {product["ProductName"]} (ID: {product["ProductID"]}, CategoryID: {product["CategoryID"]})");
                orphans++;
            }
        }

        Console.WriteLine($"\n–í—Å–µ–≥–æ —Å–∏—Ä–æ—Ç: {orphans}");
    }

    static void CheckReferentialIntegrity(DataSet ds)
    {
        DataTable categories = ds.Tables["–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"];
        DataTable products = ds.Tables["–¢–æ–≤–∞—Ä—ã"];

        Console.WriteLine("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ—á–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏:");
        Console.WriteLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");

        int valid = 0, invalid = 0;

        foreach (DataRow product in products.Rows)
        {
            int categoryID = (int)product["CategoryID"];
            DataRow[] parentCategories = product.GetParentRows("FK_Categories_Products");

            if (parentCategories.Length > 0)
                valid++;
            else
                invalid++;
        }

        Console.WriteLine($"–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å–≤—è–∑–µ–π: {valid}");
        Console.WriteLine($"–ù–∞—Ä—É—à–µ–Ω–∏–π: {invalid}");
        Console.WriteLine($"–ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏: {(double)valid / products.Rows.Count * 100:F1}%");
    }
}
