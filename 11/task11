using System;
using System.Data;

class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateOrderDataSet();
            FillTestData(ds);
            CreateCascadeRelationships(ds);
            
            Console.WriteLine("=== –ó–ê–î–ê–ù–ò–ï 11: DeleteRule + UpdateRule CASCADE ===\n");
            
            Console.WriteLine("1. –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:");
            PrintFullHierarchy(ds);
            Console.WriteLine();
            
            Console.WriteLine("2. –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ì–û –ó–ê–ö–ê–ó–ß–ò–ö–ê:");
            AddNewCustomer(ds);
            Console.WriteLine();
            
            Console.WriteLine("3. –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ß–ò–ö–ê (–∫–∞—Å–∫–∞–¥):");
            DeleteCustomerCascade(ds, 2);
            Console.WriteLine();
            
            Console.WriteLine("4. –ò–ó–ú–ï–ù–ï–ù–ò–ï ID –ó–ê–ö–ê–ó–ß–ò–ö–ê (–∫–∞—Å–∫–∞–¥):");
            UpdateCustomerIDCascade(ds, 1, 101);
            Console.WriteLine();
            
            Console.WriteLine("5. –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–∫–∞—Å–∫–∞–¥):");
            DeleteOrderCascade(ds, 3);
            Console.WriteLine();
            
            Console.WriteLine("6. –ò–ó–ú–ï–ù–ï–ù–ò–ï ID –ó–ê–ö–ê–ó–ê (–∫–∞—Å–∫–∞–¥):");
            UpdateOrderIDCascade(ds, 1, 11);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û–®–ò–ë–ö–ê: {ex.Message}");
        }
    }
    
    static DataSet CreateOrderDataSet()
    {
        DataSet ds = new DataSet("OrderDB");
        
        // –ó–∞–∫–∞–∑—á–∏–∫–∏
        DataTable customers = new DataTable("–ó–∞–∫–∞–∑—á–∏–∫–∏");
        customers.Columns.Add("CustomerID", typeof(int));
        customers.Columns.Add("CustomerName", typeof(string));
        customers.Columns.Add("Email", typeof(string));
        customers.PrimaryKey = new DataColumn[] { customers.Columns["CustomerID"] };
        
        // –ó–∞–∫–∞–∑—ã
        DataTable orders = new DataTable("–ó–∞–∫–∞–∑—ã");
        orders.Columns.Add("OrderID", typeof(int));
        orders.Columns.Add("OrderDate", typeof(DateTime));
        orders.Columns.Add("CustomerID", typeof(int));
        orders.Columns.Add("Total", typeof(decimal));
        orders.PrimaryKey = new DataColumn[] { orders.Columns["OrderID"] };
        
        // –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–æ–≤
        DataTable orderDetails = new DataTable("–î–µ—Ç–∞–ª–∏–ó–∞–∫–∞–∑–æ–≤");
        orderDetails.Columns.Add("DetailID", typeof(int));
        orderDetails.Columns.Add("OrderID", typeof(int));
        orderDetails.Columns.Add("ProductID", typeof(int));
        orderDetails.Columns.Add("Quantity", typeof(int));
        orderDetails.Columns.Add("Price", typeof(decimal));
        orderDetails.PrimaryKey = new DataColumn[] { orderDetails.Columns["DetailID"] };
        
        ds.Tables.Add(customers);
        ds.Tables.Add(orders);
        ds.Tables.Add(orderDetails);
        
        return ds;
    }
    
    static void FillTestData(DataSet ds)
    {
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        DataTable orders = ds.Tables["–ó–∞–∫–∞–∑—ã"];
        DataTable details = ds.Tables["–î–µ—Ç–∞–ª–∏–ó–∞–∫–∞–∑–æ–≤"];
        
        customers.Rows.Add(1, "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤", "ivan@example.com");
        customers.Rows.Add(2, "–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞", "maria@example.com");
        customers.Rows.Add(3, "–ê–ª–µ–∫—Å–µ–π –ù–æ–≤–∏–∫–æ–≤", "alex@example.com");
        
        orders.Rows.Add(1, new DateTime(2024, 1, 15), 1, 12500m);
        orders.Rows.Add(2, new DateTime(2024, 1, 20), 1, 8500m);
        orders.Rows.Add(3, new DateTime(2024, 2, 5), 2, 21000m);
        
        details.Rows.Add(1, 1, 101, 2, 59990m);
        details.Rows.Add(2, 1, 102, 1, 4990m);
        details.Rows.Add(3, 2, 103, 3, 2490m);
        details.Rows.Add(4, 3, 104, 1, 129990m);
        details.Rows.Add(5, 3, 105, 2, 89990m);
    }
    
    static void CreateCascadeRelationships(DataSet ds)
    {
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        DataTable orders = ds.Tables["–ó–∞–∫–∞–∑—ã"];
        DataTable details = ds.Tables["–î–µ—Ç–∞–ª–∏–ó–∞–∫–∞–∑–æ–≤"];
        
        // –ó–∞–∫–∞–∑—á–∏–∫–∏ ‚Üí –ó–∞–∫–∞–∑—ã (Cascade Delete/Update)
        ForeignKeyConstraint custOrderFK = new ForeignKeyConstraint(
            "FK_Orders_Customers",
            customers.Columns["CustomerID"], orders.Columns["CustomerID"]
        );
        custOrderFK.DeleteRule = Rule.Cascade;
        custOrderFK.UpdateRule = Rule.Cascade;
        orders.Constraints.Add(custOrderFK);
        
        DataRelation custOrderRel = new DataRelation("Rel_Customers_Orders",
            customers.Columns["CustomerID"], orders.Columns["CustomerID"]);
        ds.Relations.Add(custOrderRel);
        
        // –ó–∞–∫–∞–∑—ã ‚Üí –î–µ—Ç–∞–ª–∏ (Cascade Delete/Update)
        ForeignKeyConstraint orderDetailFK = new ForeignKeyConstraint(
            "FK_OrderDetails_Orders",
            orders.Columns["OrderID"], details.Columns["OrderID"]
        );
        orderDetailFK.DeleteRule = Rule.Cascade;
        orderDetailFK.UpdateRule = Rule.Cascade;
        details.Constraints.Add(orderDetailFK);
        
        DataRelation orderDetailRel = new DataRelation("Rel_Orders_Details",
            orders.Columns["OrderID"], details.Columns["OrderID"]);
        ds.Relations.Add(orderDetailRel);
    }
    
    static void AddNewCustomer(DataSet ds)
    {
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        customers.Rows.Add(4, "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑—á–∏–∫", "new@example.com");
        
        Console.WriteLine("‚úì –ù–æ–≤—ã–π –∑–∞–∫–∞–∑—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω (ID=4)");
        Console.WriteLine($"–í—Å–µ–≥–æ –∑–∞–∫–∞–∑—á–∏–∫–æ–≤: {customers.Rows.Count}");
    }
    
    static void DeleteCustomerCascade(DataSet ds, int customerID)
    {
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        DataRow customer = customers.Rows.Find(customerID);
        
        if (customer != null)
        {
            Console.WriteLine($"–£–î–ê–õ–Ø–ï–ú –∑–∞–∫–∞–∑—á–∏–∫–∞ ID={customerID}: {customer["CustomerName"]}");
            customer.Delete();
            ds.AcceptChanges();
            
            Console.WriteLine("‚úì –ö–∞—Å–∫–∞–¥–Ω–æ —É–¥–∞–ª–µ–Ω—ã:");
            Console.WriteLine($"  - –ó–∞–∫–∞–∑—á–∏–∫ ID={customerID}");
            Console.WriteLine($"  - –í—Å–µ –µ–≥–æ –∑–∞–∫–∞–∑—ã");
            Console.WriteLine($"  - –í—Å–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–æ–≤");
        }
    }
    
    static void UpdateCustomerIDCascade(DataSet ds, int oldID, int newID)
    {
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        DataRow customer = customers.Rows.Find(oldID);
        
        if (customer != null)
        {
            Console.WriteLine($"–ò–ó–ú–ï–ù–Ø–ï–ú ID –∑–∞–∫–∞–∑—á–∏–∫–∞ {oldID} ‚Üí {newID}");
            customer["CustomerID"] = newID;
            ds.AcceptChanges();
            
            Console.WriteLine($"‚úì –ö–∞—Å–∫–∞–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:");
            Console.WriteLine($"  - –ó–∞–∫–∞–∑—á–∏–∫: {oldID} ‚Üí {newID}");
            Console.WriteLine($"  - –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã: {oldID} ‚Üí {newID}");
        }
    }
    
    static void DeleteOrderCascade(DataSet ds, int orderID)
    {
        DataTable orders = ds.Tables["–ó–∞–∫–∞–∑—ã"];
        DataRow order = orders.Rows.Find(orderID);
        
        if (order != null)
        {
            Console.WriteLine($"–£–î–ê–õ–Ø–ï–ú –∑–∞–∫–∞–∑ ID={orderID}");
            order.Delete();
            ds.AcceptChanges();
            
            Console.WriteLine($"‚úì –ö–∞—Å–∫–∞–¥–Ω–æ —É–¥–∞–ª–µ–Ω—ã:");
            Console.WriteLine($"  - –ó–∞–∫–∞–∑ ID={orderID}");
            Console.WriteLine($"  - –í—Å–µ –µ–≥–æ –¥–µ—Ç–∞–ª–∏");
        }
    }
    
    static void UpdateOrderIDCascade(DataSet ds, int oldID, int newID)
    {
        DataTable orders = ds.Tables["–ó–∞–∫–∞–∑—ã"];
        DataRow order = orders.Rows.Find(oldID);
        
        if (order != null)
        {
            Console.WriteLine($"–ò–ó–ú–ï–ù–Ø–ï–ú ID –∑–∞–∫–∞–∑–∞ {oldID} ‚Üí {newID}");
            order["OrderID"] = newID;
            ds.AcceptChanges();
            
            Console.WriteLine($"‚úì –ö–∞—Å–∫–∞–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:");
            Console.WriteLine($"  - –ó–∞–∫–∞–∑: {oldID} ‚Üí {newID}");
            Console.WriteLine($"  - –í—Å–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: {oldID} ‚Üí {newID}");
        }
    }
    
    static void PrintFullHierarchy(DataSet ds)
    {
        Console.WriteLine("–ò–ï–†–ê–†–•–ò–Ø –î–ê–ù–ù–´–•:");
        Console.WriteLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        
        DataTable customers = ds.Tables["–ó–∞–∫–∞–∑—á–∏–∫–∏"];
        Console.WriteLine($"\nüìä –ó–ê–ö–ê–ó–ß–ò–ö–ò ({customers.Rows.Count}):");
        foreach (DataRow cust in customers.Rows)
        {
            Console.WriteLine($"  {cust["CustomerID"]}. {cust["CustomerName"]} ({cust["Email"]})");
            
            DataRow[] orders = cust.GetChildRows("Rel_Customers_Orders");
            foreach (DataRow order in orders)
            {
                Console.WriteLine($"    ‚îî‚îÄ‚îÄ –ó–∞–∫–∞–∑ {order["OrderID"]} ({((DateTime)order["OrderDate"]):dd.MM.yy}, {((decimal)order["Total"]):N0}‚ÇΩ)");
                
                DataRow[] details = order.GetChildRows("Rel_Orders_Details");
                foreach (DataRow detail in details)
                {
                    Console.WriteLine($"        ‚îî‚îÄ‚îÄ –î–µ—Ç–∞–ª—å {detail["DetailID"]}: –¢–æ–≤–∞—Ä {detail["ProductID"]}, {detail["Quantity"]}x{((decimal)detail["Price"]):N0}‚ÇΩ");
                }
            }
        }
    }
}
