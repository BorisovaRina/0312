using System;
using System.Data;

class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateOrderDataSet();
            FillTestData(ds);
            CreateCascadeRelationships(ds);
            
            Console.WriteLine("=== Ğ—ĞĞ”ĞĞĞ˜Ğ• 15: ĞšĞĞ¡ĞšĞĞ”ĞĞĞ• Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ• + RowState.Deleted ===\n");
            
            Console.WriteLine("1. Ğ˜Ğ¡Ğ¥ĞĞ”ĞĞĞ¯ Ğ˜Ğ•Ğ ĞĞ Ğ¥Ğ˜Ğ¯:");
            PrintFullHierarchy(ds);
            Console.WriteLine();
            
            Console.WriteLine("2. ĞšĞĞ¡ĞšĞĞ”ĞĞĞ• Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ• Ğ—ĞĞšĞĞ—Ğ§Ğ˜ĞšĞ ID=1:");
            PerformCascadeDelete(ds, 1);
            Console.WriteLine();
            
            Console.WriteLine("3. ĞĞ¢Ğ§ĞĞ¢ Ğ Ğ’Ğ¡Ğ•Ğ¥ Ğ£Ğ”ĞĞ›ĞĞĞĞ«Ğ¥ Ğ¡Ğ¢Ğ ĞĞšĞĞ¥:");
            PrintAllDeletedRowsReport(ds);
            Console.WriteLine();
            
            Console.WriteLine("4. Ğ¦Ğ•ĞŸĞĞ§ĞšĞ ĞšĞĞ¡ĞšĞĞ”ĞĞĞ“Ğ Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ¯:");
            PrintCascadeDeletionChain(ds);
            Console.WriteLine();
            
            Console.WriteLine("5. ĞĞ¢ĞšĞĞ¢ Ğ’Ğ¡Ğ•Ğ¥ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™:");
            RollbackAllChanges(ds);
            Console.WriteLine();
            
            Console.WriteLine("6. ĞŸĞĞ¡Ğ›Ğ• ĞĞ¢ĞšĞĞ¢Ğ:");
            PrintFinalState(ds);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ĞĞ¨Ğ˜Ğ‘ĞšĞ: {ex.Message}");
        }
    }
    
    static DataSet CreateOrderDataSet()
    {
        DataSet ds = new DataSet("OrderDB");
        
        DataTable customers = new DataTable("Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸");
        customers.Columns.Add("CustomerID", typeof(int));
        customers.Columns.Add("CustomerName", typeof(string));
        customers.Columns.Add("Email", typeof(string));
        customers.PrimaryKey = new DataColumn[] { customers.Columns["CustomerID"] };
        
        DataTable orders = new DataTable("Ğ—Ğ°ĞºĞ°Ğ·Ñ‹");
        orders.Columns.Add("OrderID", typeof(int));
        orders.Columns.Add("OrderDate", typeof(DateTime));
        orders.Columns.Add("CustomerID", typeof(int));
        orders.Columns.Add("Total", typeof(decimal));
        orders.PrimaryKey = new DataColumn[] { orders.Columns["OrderID"] };
        
        DataTable orderDetails = new DataTable("Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²");
        orderDetails.Columns.Add("DetailID", typeof(int));
        orderDetails.Columns.Add("OrderID", typeof(int));
        orderDetails.Columns.Add("ProductID", typeof(int));
        orderDetails.Columns.Add("Quantity", typeof(int));
        orderDetails.Columns.Add("Price", typeof(decimal));
        orderDetails.PrimaryKey = new DataColumn[] { orderDetails.Columns["DetailID"] };
        
        ds.Tables.Add(customers);
        ds.Tables.Add(orders);
        ds.Tables.Add(orderDetails);
        
        return ds;
    }
    
    static void FillTestData(DataSet ds)
    {
        DataTable customers = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"];
        DataTable orders = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‹"];
        DataTable details = ds.Tables["Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"];
        
        customers.Rows.Add(1, "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²", "ivan@example.com");
        customers.Rows.Add(2, "ĞœĞ°Ñ€Ğ¸Ñ Ğ¡Ğ¸Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ°", "maria@example.com");
        
        orders.Rows.Add(1, new DateTime(2024, 1, 15), 1, 12500m);
        orders.Rows.Add(2, new DateTime(2024, 1, 20), 1, 8500m);
        orders.Rows.Add(3, new DateTime(2024, 2, 5), 2, 21000m);
        
        details.Rows.Add(1, 1, 101, 2, 59990m);
        details.Rows.Add(2, 1, 102, 1, 4990m);
        details.Rows.Add(3, 2, 103, 3, 2490m);
        details.Rows.Add(4, 3, 104, 1, 129990m);
        details.Rows.Add(5, 3, 105, 2, 89990m);
    }
    
    static void CreateCascadeRelationships(DataSet ds)
    {
        DataTable customers = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"];
        DataTable orders = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‹"];
        DataTable details = ds.Tables["Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"];
        
        // Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸ â†’ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ (Cascade)
        ForeignKeyConstraint custOrderFK = new ForeignKeyConstraint(
            "FK_Orders_Customers",
            customers.Columns["CustomerID"], orders.Columns["CustomerID"]
        );
        custOrderFK.DeleteRule = Rule.Cascade;
        orders.Constraints.Add(custOrderFK);
        DataRelation custOrderRel = new DataRelation("Rel_Customers_Orders",
            customers.Columns["CustomerID"], orders.Columns["CustomerID"]);
        ds.Relations.Add(custOrderRel);
        
        // Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ â†’ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ (Cascade)
        ForeignKeyConstraint orderDetailFK = new ForeignKeyConstraint(
            "FK_OrderDetails_Orders",
            orders.Columns["OrderID"], details.Columns["OrderID"]
        );
        orderDetailFK.DeleteRule = Rule.Cascade;
        details.Constraints.Add(orderDetailFK);
        DataRelation orderDetailRel = new DataRelation("Rel_Orders_Details",
            orders.Columns["OrderID"], details.Columns["OrderID"]);
        ds.Relations.Add(orderDetailRel);
    }
    
    static void PerformCascadeDelete(DataSet ds, int customerID)
    {
        DataTable customers = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"];
        DataRow customer = customers.Rows.Find(customerID);
        
        if (customer != null)
        {
            Console.WriteLine($"âœ“ ĞšĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ° ID={customerID}: {customer["CustomerName"]}");
            customer.Delete();
            Console.WriteLine("  â†’ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ + Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²");
            Console.WriteLine("  â†’ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞĞ• ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸)");
        }
    }
    
    static void PrintAllDeletedRowsReport(DataSet ds)
    {
        Console.WriteLine("Ğ’Ğ¡Ğ• Ğ£Ğ”ĞĞ›ĞĞĞĞ«Ğ• Ğ¡Ğ¢Ğ ĞĞšĞ˜ ĞŸĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦ĞĞœ (RowState.Deleted):");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        // Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸
        PrintDeletedTableReport(ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"], "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸");
        
        // Ğ—Ğ°ĞºĞ°Ğ·Ñ‹
        PrintDeletedTableReport(ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‹"], "Ğ—Ğ°ĞºĞ°Ğ·Ñ‹");
        
        // Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸
        PrintDeletedTableReport(ds.Tables["Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"], "Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²");
    }
    
    static void PrintDeletedTableReport(DataTable table, string tableName)
    {
        DataRow[] deletedRows = table.Select("", "", DataViewRowState.Deleted);
        
        Console.WriteLine($"\nğŸ“‹ {tableName} ({deletedRows.Length} ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ñ‹Ñ…):");
        Console.WriteLine(new string('â”€', 50));
        
        foreach (DataRow deletedRow in deletedRows)
        {
            try
            {
                Console.Write($"[ID: {deletedRow[table.PrimaryKey[0].ColumnName, DataRowVersion.Original]}] ");
                
                for (int i = 0; i < table.Columns.Count; i++)
                {
                    if (i > 0) Console.Write(" | ");
                    object value = deletedRow[table.Columns[i].ColumnName, DataRowVersion.Original];
                    Console.Write(value?.ToString() ?? "NULL");
                }
                Console.WriteLine();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"  ĞĞ¨Ğ˜Ğ‘ĞšĞ: {ex.Message}");
            }
        }
    }
    
    static void PrintCascadeDeletionChain(DataSet ds)
    {
        Console.WriteLine("\nĞ¦Ğ•ĞŸĞĞ§ĞšĞ ĞšĞĞ¡ĞšĞĞ”ĞĞĞ“Ğ Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ¯:");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        DataTable customers = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"];
        DataRow[] deletedCustomers = customers.Select("", "", DataViewRowState.Deleted);
        
        foreach (DataRow deletedCustomer in deletedCustomers)
        {
            int custID = (int)deletedCustomer["CustomerID", DataRowVersion.Original];
            string custName = (string)deletedCustomer["CustomerName", DataRowVersion.Original];
            
            Console.WriteLine($"\nğŸš« Ğ—ĞĞšĞĞ—Ğ§Ğ˜Ğš [ID:{custID}] {custName}");
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ·Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ°
            DataRow[] deletedOrders = deletedCustomer.GetChildRows("Rel_Customers_Orders", DataRowVersion.Original);
            Console.WriteLine($"  â†“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²: {deletedOrders.Length}");
            
            foreach (DataRow deletedOrder in deletedOrders)
            {
                int orderID = (int)deletedOrder["OrderID", DataRowVersion.Original];
                Console.WriteLine($"    â””â”€â”€ Ğ—ĞĞšĞĞ— [ID:{orderID}] {((DateTime)deletedOrder["OrderDate", DataRowVersion.Original]):dd.MM.yy}");
                
                // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
                DataRow[] deletedDetails = deletedOrder.GetChildRows("Rel_Orders_Details", DataRowVersion.Original);
                Console.WriteLine($"       â†“ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹: {deletedDetails.Length}");
                
                foreach (DataRow deletedDetail in deletedDetails)
                {
                    Console.WriteLine($"          â””â”€â”€ Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ [ID:{deletedDetail["DetailID", DataRowVersion.Original]}]");
                }
            }
        }
    }
    
    static void RollbackAllChanges(DataSet ds)
    {
        Console.WriteLine("\nĞĞ¢ĞšĞĞ¢ Ğ’Ğ¡Ğ•Ğ¥ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ (RejectChanges):");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        ds.RejectChanges();
        Console.WriteLine("âœ“ Ğ’ÑĞµ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹");
        Console.WriteLine("âœ“ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ´Ğ¾ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ");
    }
    
    static void PrintFullHierarchy(DataSet ds)
    {
        DataTable customers = ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"];
        Console.WriteLine("Ğ˜Ğ•Ğ ĞĞ Ğ¥Ğ˜Ğ¯ Ğ”Ğ ĞšĞĞ¡ĞšĞĞ”ĞĞĞ“Ğ Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ¯:");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        foreach (DataRow cust in customers.Rows)
        {
            Console.WriteLine($"ğŸ“Š {cust["CustomerID"]}. {cust["CustomerName"]}");
            
            DataRow[] orders = cust.GetChildRows("Rel_Customers_Orders");
            foreach (DataRow order in orders)
            {
                Console.WriteLine($"  â””â”€â”€ Ğ—Ğ°ĞºĞ°Ğ· {order["OrderID"]} ({((DateTime)order["OrderDate"]):dd.MM.yy}, {((decimal)order["Total"]):N0}â‚½)");
                
                DataRow[] details = order.GetChildRows("Rel_Orders_Details");
                foreach (DataRow detail in details)
                {
                    Console.WriteLine($"     â””â”€â”€ {detail["Quantity"]}x Ğ¢Ğ¾Ğ²Ğ°Ñ€{detail["ProductID"]} ({((decimal)detail["Price"]):N0}â‚½)");
                }
            }
        }
    }
    
    static void PrintFinalState(DataSet ds)
    {
        Console.WriteLine("\nĞ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ• Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• ĞŸĞĞ¡Ğ›Ğ• ĞĞ¢ĞšĞĞ¢Ğ:");
        Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        Console.WriteLine($"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸: {ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸ĞºĞ¸"].Rows.Count}");
        Console.WriteLine($"Ğ—Ğ°ĞºĞ°Ğ·Ñ‹: {ds.Tables["Ğ—Ğ°ĞºĞ°Ğ·Ñ‹"].Rows.Count}");
        Console.WriteLine($"Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸: {ds.Tables["Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ²"].Rows.Count}");
        Console.WriteLine("âœ“ Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹!");
    }
}
