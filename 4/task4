using System;
using System.Data;
using System.Collections.Generic;

class Program
{
    static void Main()
    {
        try
        {
            DataSet ds = CreateDataSet();
            FillTestData(ds);
            CreateSelfRelationship(ds);
            
            Console.WriteLine("=== Ğ—ĞĞ”ĞĞĞ˜Ğ• 4: ĞĞ¢ĞĞĞ¨Ğ•ĞĞ˜Ğ• \"Ğ¡ĞĞœ Ğš Ğ¡Ğ•Ğ‘Ğ•\" ===\n");
            
            Console.WriteLine("1. Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ ĞĞ‘ ĞĞ¢ĞĞĞ¨Ğ•ĞĞ˜Ğ˜:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            PrintRelationInfo(ds);
            Console.WriteLine();
            
            Console.WriteLine("2. Ğ”Ğ•Ğ Ğ•Ğ’Ğ Ğ˜Ğ•Ğ ĞĞ Ğ¥Ğ˜Ğ˜ Ğ¡ĞĞ¢Ğ Ğ£Ğ”ĞĞ˜ĞšĞĞ’:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            PrintHierarchyTree(ds);
            Console.WriteLine();
            
            Console.WriteLine("3. Ğ¡ĞĞ¢Ğ Ğ£Ğ”ĞĞ˜ĞšĞ˜ Ğ¡ Ğ Ğ£ĞšĞĞ’ĞĞ”Ğ˜Ğ¢Ğ•Ğ›Ğ¯ĞœĞ˜:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            PrintEmployeesWithManagers(ds);
            Console.WriteLine();
            
            Console.WriteLine("4. ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ Ğ« Ğ˜ ĞŸĞĞ”Ğ§Ğ˜ĞĞĞĞĞ«Ğ•:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            PrintManagersWithSubordinates(ds);
            Console.WriteLine();
            
            Console.WriteLine("5. Ğ“Ğ›Ğ£Ğ‘Ğ˜ĞĞ Ğ˜Ğ•Ğ ĞĞ Ğ¥Ğ˜Ğ˜:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            CalculateHierarchyDepth(ds);
            Console.WriteLine();
            
            Console.WriteLine("6. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ¦Ğ˜ĞšĞ›Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ¥ Ğ¡Ğ¡Ğ«Ğ›ĞĞš:");
            Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            CheckCircularReferences(ds);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ĞĞ¨Ğ˜Ğ‘ĞšĞ: {ex.Message}");
        }
    }
    
    static DataSet CreateDataSet()
    {
        DataSet ds = new DataSet("CompanyDB");
        
        DataTable employees = new DataTable("Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸");
        employees.Columns.Add("EmployeeID", typeof(int));
        employees.Columns.Add("EmployeeName", typeof(string));
        employees.Columns.Add("Department", typeof(string));
        employees.Columns.Add("Salary", typeof(decimal));
        employees.Columns.Add("ManagerID", typeof(int));
        employees.PrimaryKey = new DataColumn[] { employees.Columns["EmployeeID"] };
        
        ds.Tables.Add(employees);
        return ds;
    }
    
    static void FillTestData(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        
        employees.Rows.Add(1, "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²", "Ğ“ĞµĞ½ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€", 500000m, DBNull.Value);
        employees.Rows.Add(2, "ĞœĞ°Ñ€Ğ¸Ñ Ğ¡Ğ¸Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ°", "HR Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€", 250000m, 1);
        employees.Rows.Add(3, "ĞĞ»ĞµĞºÑĞµĞ¹ ĞĞ¾Ğ²Ğ¸ĞºĞ¾Ğ²", "IT Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€", 300000m, 1);
        employees.Rows.Add(4, "Ğ•Ğ»ĞµĞ½Ğ° ĞšĞ¾Ğ·Ğ»Ğ¾Ğ²Ğ°", "HR ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€", 150000m, 2);
        employees.Rows.Add(5, "Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹ Ğ’Ğ¾Ğ»ĞºĞ¾Ğ²", "Lead Developer", 200000m, 3);
        employees.Rows.Add(6, "ĞĞ½Ğ½Ğ° Ğ¡Ğ¼Ğ¸Ñ€Ğ½Ğ¾Ğ²Ğ°", "HR Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚", 120000m, 4);
        employees.Rows.Add(7, "ĞŸĞµÑ‚Ñ€ Ğ¡ĞµÑ€Ğ³ĞµĞµĞ²", "Senior Developer", 180000m, 5);
        employees.Rows.Add(8, "ĞĞ»ÑŒĞ³Ğ° Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ°", "Junior Developer", 90000m, 5);
        employees.Rows.Add(9, "Ğ¡ĞµÑ€Ğ³ĞµĞ¹ ĞœĞ¾Ñ€Ğ¾Ğ·Ğ¾Ğ²", "QA Engineer", 110000m, 5);
    }
    
    static void CreateSelfRelationship(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        
        DataRelation selfRelation = new DataRelation(
            "FK_Employees_Manager",
            employees.Columns["EmployeeID"],
            employees.Columns["ManagerID"],
            false
        );
        
        ds.Relations.Add(selfRelation);
    }
    
    static void PrintRelationInfo(DataSet ds)
    {
        DataRelation relation = ds.Relations["FK_Employees_Manager"];
        
        Console.WriteLine($"Ğ˜Ğ¼Ñ: {relation.RelationName}");
        Console.WriteLine($"Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: {relation.ParentTable.TableName} (ÑĞ°Ğ¼Ğ¾ÑÑÑ‹Ğ»ĞºĞ°)");
        Console.WriteLine($"ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸: EmployeeID â†’ ManagerID");
    }
    
    static void PrintHierarchyTree(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        DataRow[] rootEmployees = employees.Select("ManagerID IS NULL");
        
        PrintTreeRecursive(rootEmployees, ds, 0);
    }
    
    static void PrintTreeRecursive(DataRow[] employees, DataSet ds, int level)
    {
        string indent = new string(' ', level * 4);
        string prefix = level == 0 ? "ğŸ“Š " : "â”œâ”€â”€ ";
        
        foreach (DataRow emp in employees)
        {
            int empID = (int)emp["EmployeeID"];
            string name = (string)emp["EmployeeName"];
            string dept = (string)emp["Department"];
            decimal salary = (decimal)emp["Salary"];
            
            Console.WriteLine($"{indent}{prefix}{name} (ID:{empID}) - {dept} - {salary:N0}â‚½");
            
            DataRow[] children = emp.GetChildRows("FK_Employees_Manager");
            if (children.Length > 0)
                PrintTreeRecursive(children, ds, level + 1);
        }
    }
    
    static void PrintEmployeesWithManagers(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        
        Console.WriteLine("Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº             | Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ         | ĞÑ‚Ğ´ĞµĞ»");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        
        foreach (DataRow emp in employees.Rows)
        {
            string empName = (string)emp["EmployeeName"];
            string dept = (string)emp["Department"];
            
            DataRow[] managerRows = emp.GetParentRows("FK_Employees_Manager");
            string managerName = managerRows.Length > 0 ? (string)managerRows[0]["EmployeeName"] : "ĞĞµÑ‚ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ";
            
            Console.WriteLine($"{empName,-20} | {managerName,-20} | {dept}");
        }
    }
    
    static void PrintManagersWithSubordinates(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        
        Console.WriteLine("ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€              | ĞŸĞ¾Ğ´Ñ‡Ğ¸Ğ½Ñ‘Ğ½Ğ½Ñ‹Ñ…");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        
        foreach (DataRow emp in employees.Rows)
        {
            DataRow[] subordinates = emp.GetChildRows("FK_Employees_Manager");
            if (subordinates.Length > 0)
            {
                string managerName = (string)emp["EmployeeName"];
                Console.WriteLine($"{managerName,-20} | {subordinates.Length,11}");
                
                foreach (DataRow sub in subordinates)
                {
                    Console.WriteLine($"{' ',23}â””â”€â”€ {sub["EmployeeName"]} ({sub["Department"]})");
                }
                Console.WriteLine();
            }
        }
    }
    
    static void CalculateHierarchyDepth(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        
        Console.WriteLine("Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº             | Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        
        foreach (DataRow emp in employees.Rows)
        {
            int empID = (int)emp["EmployeeID"];
            int depth = GetEmployeeDepth(ds, empID, new HashSet<int>(), 0);
            
            string name = (string)emp["EmployeeName"];
            string levelIndicator = new string('â”€', Math.Min(depth, 20));
            Console.WriteLine($"{name,-20} | {depth} ({levelIndicator})");
        }
    }
    
    static int GetEmployeeDepth(DataSet ds, int empID, HashSet<int> visited, int currentDepth)
    {
        if (visited.Contains(empID))
            return -1;
        
        visited.Add(empID);
        
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        DataRow[] empRows = employees.Select($"EmployeeID = {empID}");
        
        if (empRows.Length == 0)
            return currentDepth;
        
        DataRow emp = empRows[0];
        if (emp["ManagerID"] == DBNull.Value)
            return currentDepth;
        
        int managerID = (int)emp["ManagerID"];
        return GetEmployeeDepth(ds, managerID, visited, currentDepth + 1);
    }
    
    static void CheckCircularReferences(DataSet ds)
    {
        DataTable employees = ds.Tables["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸"];
        int cycles = 0;
        
        Console.WriteLine("Ğ¦Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑÑ‹Ğ»ĞºĞ¸:");
        Console.WriteLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        
        foreach (DataRow emp in employees.Rows)
        {
            int empID = (int)emp["EmployeeID"];
            HashSet<int> visited = new HashSet<int>();
            int depth = GetEmployeeDepth(ds, empID, visited, 0);
            
            if (depth == -1)
            {
                string name = (string)emp["EmployeeName"];
                Console.WriteLine($"âš ï¸ Ğ¦Ğ˜ĞšĞ›: {name} (ID: {empID})");
                cycles++;
            }
        }
        
        Console.WriteLine($"\nĞ¦Ğ¸ĞºĞ»Ğ¾Ğ² Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾: {cycles}");
    }
}
